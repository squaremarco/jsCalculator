/*!
 Based on ndef.parser, by Raphael Graf(r@undefined.ch)
 http://www.undefined.ch/mparser/index.html

 Ported to JavaScript and modified by Matthew Crumley (email@matthewcrumley.com, http://silentmatt.com/)

 You are free to use and modify this code in anyway you find useful. Please leave this comment in the code
 to acknowledge its original source. If you feel like it, I enjoy hearing about projects that use my code,
 but don't feel like you have to let me know or ask permission.
*/
if(!Array.indexOf){Array.prototype.indexOf=function(b,c){for(var a=(c||0);a<this.length;a++){if(this[a]===b){return a}}return -1}}var Parser=(function(K){function P(ac){function ab(){}ab.prototype=ac;return new ab()}var Q=0;var M=1;var I=2;var x=3;var H=4;function e(ab,ad,ac,ae){this.type_=ab;this.index_=ad||0;this.prio_=ac||0;this.number_=(ae!==undefined&&ae!==null)?ae:0;this.toString=function(){switch(this.type_){case Q:return this.number_;case M:case I:case x:return this.index_;case H:return"CALL";default:return"Invalid Token"}}}function S(ae,ac,ab,ad){this.tokens=ae;this.ops1=ac;this.ops2=ab;this.functions=ad}var w=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,T=/[\\\'\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,l={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'","\\":"\\\\"};function L(ab){if(typeof ab==="string"){T.lastIndex=0;return T.test(ab)?"'"+ab.replace(T,function(ac){var ad=l[ac];return typeof ad==="string"?ad:"\\u"+("0000"+ac.charCodeAt(0).toString(16)).slice(-4)})+"'":"'"+ab+"'"}return ab}function q(ab,ad){var af=ad.split(/\./);var ae=ab;var ac;while(ac=af.shift()){if(!(ac in ae)){return false}ae=ae[ac]}return true}function J(ab,ad){var af=ad.split(/\./);var ae=ab;var ac;while(ac=af.shift()){ae=ae[ac]}return ae}S.prototype={simplify:function(aj){aj=aj||{};var ae=[];var ad=[];var ah;var ag;var af;var ai=this.tokens.length;var ak;var ac=0;for(ac=0;ac<ai;ac++){ak=this.tokens[ac];var ab=ak.type_;if(ab===Q){ae.push(ak)}else{if(ab===x&&q(aj,ak.index_)){ak=new e(Q,0,0,J(aj,ak.index_));ae.push(ak)}else{if(ab===I&&ae.length>1){ag=ae.pop();ah=ae.pop();af=this.ops2[ak.index_];ak=new e(Q,0,0,af(ah.number_,ag.number_));ae.push(ak)}else{if(ab===M&&ae.length>0){ah=ae.pop();af=this.ops1[ak.index_];ak=new e(Q,0,0,af(ah.number_));ae.push(ak)}else{while(ae.length>0){ad.push(ae.shift())}ad.push(ak)}}}}}while(ae.length>0){ad.push(ae.shift())}return new S(ad,P(this.ops1),P(this.ops2),P(this.functions))},substitute:function(ac,ak){if(!(ak instanceof S)){ak=new d().parse(String(ak))}var ah=[];var aj=this.tokens.length;var al;var ae=0;for(ae=0;ae<aj;ae++){al=this.tokens[ae];var af=al.type_;if(af===x&&al.index_===ac){for(var ad=0;ad<ak.tokens.length;ad++){var ag=ak.tokens[ad];var ab=new e(ag.type_,ag.index_,ag.prio_,ag.number_);ah.push(ab)}}else{ah.push(al)}}var ai=new S(ah,P(this.ops1),P(this.ops2),P(this.functions));return ai},evaluate:function(ai){ai=ai||{};var ad=[];var ag;var af;var ae;var ah=this.tokens.length;var aj;var ac=0;for(ac=0;ac<ah;ac++){aj=this.tokens[ac];var ab=aj.type_;if(ab===Q){ad.push(aj.number_)}else{if(ab===I){af=ad.pop();ag=ad.pop();ae=this.ops2[aj.index_];ad.push(ae(ag,af))}else{if(ab===x){if(q(ai,aj.index_)){ad.push(J(ai,aj.index_))}else{if(q(this.functions,aj.index_)){ad.push(J(this.functions,aj.index_))}else{throw new Error("undefined variable: "+aj.index_)}}}else{if(ab===M){ag=ad.pop();ae=this.ops1[aj.index_];ad.push(ae(ag))}else{if(ab===H){ag=ad.pop();ae=ad.pop();if(ae.apply&&ae.call){if(Object.prototype.toString.call(ag)=="[object Array]"){ad.push(ae.apply(undefined,ag))}else{ad.push(ae.call(undefined,ag))}}else{throw new Error(ae+" is not a function")}}else{throw new Error("invalid Expression")}}}}}}if(ad.length>1){throw new Error("invalid Expression (parity)")}return ad[0]},toString:function(ae){var ad=[];var ah;var ag;var af;var ai=this.tokens.length;var aj;var ac=0;for(ac=0;ac<ai;ac++){aj=this.tokens[ac];var ab=aj.type_;if(ab===Q){ad.push(L(aj.number_))}else{if(ab===I){ag=ad.pop();ah=ad.pop();af=aj.index_;if(ae&&af=="^"){ad.push("Math.pow("+ah+","+ag+")")}else{ad.push("("+ah+af+ag+")")}}else{if(ab===x){ad.push(aj.index_)}else{if(ab===M){ah=ad.pop();af=aj.index_;if(af==="-"){ad.push("("+af+ah+")")}else{ad.push(af+"("+ah+")")}}else{if(ab===H){ah=ad.pop();af=ad.pop();ad.push(af+"("+ah+")")}else{throw new Error("invalid Expression")}}}}}}if(ad.length>1){throw new Error("invalid Expression (parity)")}return ad[0]},variables:function(){var ab=this.tokens.length;var ae=[];for(var ac=0;ac<ab;ac++){var ad=this.tokens[ac];if(ad.type_===x&&(ae.indexOf(ad.index_)==-1)){ae.push(ad.index_)}}return ae},toJSFunction:function(ac,ad){var ab=new Function(ac,"with(Parser.values) { return "+this.simplify(ad).toString(true)+"; }");return ab}};function f(ac,ab){return Number(ac)+Number(ab)}function y(ac,ab){return ac-ab}function b(ac,ab){return ac*ab}function X(ac,ab){return ac/ab}function h(ac,ab){return ac%ab}function C(ac,ab){return""+ac+ab}function v(ac,ab){return ac==ab}function Y(ac,ab){return ac!=ab}function i(ac,ab){return ac>ab}function n(ac,ab){return ac<ab}function N(ac,ab){return ac>=ab}function r(ac,ab){return ac<=ab}function j(ac,ab){return Boolean(ac&&ab)}function aa(ac,ab){return Boolean(ac||ab)}function c(ab){return Math.sinh?Math.sinh(ab):((Math.exp(ab)-Math.exp(-ab))/2)}function k(ab){return Math.cosh?Math.cosh(ab):((Math.exp(ab)+Math.exp(-ab))/2)}function u(ab){if(Math.tanh){return Math.tanh(ab)}if(ab===Infinity){return 1}if(ab===-Infinity){return -1}return(Math.exp(ab)-Math.exp(-ab))/(Math.exp(ab)+Math.exp(-ab))}function B(ab){if(Math.asinh){return Math.asinh(ab)}if(ab===-Infinity){return ab}return Math.log(ab+Math.sqrt(ab*ab+1))}function F(ab){return Math.acosh?Math.acosh(ab):Math.log(ab+Math.sqrt(ab*ab-1))}function U(ab){return Math.atanh?Math.atanh(ab):(Math.log((1+ab)/(1-ab))/2)}function E(ab){return Math.log(ab)*Math.LOG10E}function o(ab){return -ab}function D(ab){if(Math.trunc){return Math.trunc(ab)}else{return ab<0?Math.ceil(ab):Math.floor(ab)}}function A(ab){return Math.random()*(ab||1)}function z(ac){ac=Math.floor(ac);var ab=ac;while(ac>1){ab=ab*(--ac)}return ab}function R(){if(Math.hypot){return Math.hypot.apply(this,arguments)}var ad=0;var ac=arguments.length;for(var ab=0;ab<ac;ab++){if(arguments[ab]===Infinity||arguments[ab]===-Infinity){return Infinity}ad+=arguments[ab]*arguments[ab]}return Math.sqrt(ad)}function g(ac,ab,ad){return ac?ab:ad}function O(ac,ab){if(Object.prototype.toString.call(ac)!="[object Array]"){return[ac,ab]}ac=ac.slice();ac.push(ab);return ac}function d(){this.success=false;this.errormsg="";this.expression="";this.pos=0;this.tokennumber=0;this.tokenprio=0;this.tokenindex=0;this.tmpprio=0;this.ops1={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:c,cosh:k,tanh:u,asinh:B,acosh:F,atanh:U,sqrt:Math.sqrt,log:Math.log,lg:E,log10:E,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:D,"-":o,exp:Math.exp};this.ops2={"+":f,"-":y,"*":b,"/":X,"%":h,"^":Math.pow,",":O,"||":C,"==":v,"!=":Y,">":i,"<":n,">=":N,"<=":r,and:j,or:aa};this.functions={random:A,fac:z,min:Math.min,max:Math.max,hypot:R,pyt:R,pow:Math.pow,atan2:Math.atan2,"if":g};this.consts={E:Math.E,PI:Math.PI}}d.parse=function(ab){return new d().parse(ab)};d.evaluate=function(ab,ac){return d.parse(ab).evaluate(ac)};d.Expression=S;d.values={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:c,cosh:k,tanh:u,asinh:B,acosh:F,atanh:U,sqrt:Math.sqrt,log:Math.log,lg:E,log10:E,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:D,random:A,fac:z,exp:Math.exp,min:Math.min,max:Math.max,hypot:R,pyt:R,pow:Math.pow,atan2:Math.atan2,"if":g,E:Math.E,PI:Math.PI};var Z=1<<0;var V=1<<1;var a=1<<2;var m=1<<3;var p=1<<4;var s=1<<5;var G=1<<6;var t=1<<7;var W=1<<8;d.prototype={parse:function(ai){this.errormsg="";this.success=true;var ad=[];var aj=[];this.tmpprio=0;var af=(Z|m|a|G);var ag=0;this.expression=ai;this.pos=0;while(this.pos<this.expression.length){if(this.isOperator()){if(this.isSign()&&(af&G)){if(this.isNegativeSign()){this.tokenprio=2;this.tokenindex="-";ag++;this.addfunc(aj,ad,M)}af=(Z|m|a|G)}else{if(this.isComment()){}else{if((af&V)===0){this.error_parsing(this.pos,"unexpected operator")}ag+=2;this.addfunc(aj,ad,I);af=(Z|m|a|G)}}}else{if(this.isNumber()){if((af&Z)===0){this.error_parsing(this.pos,"unexpected number")}var ac=new e(Q,0,0,this.tokennumber);aj.push(ac);af=(V|p|s)}else{if(this.isString()){if((af&Z)===0){this.error_parsing(this.pos,"unexpected string")}var ac=new e(Q,0,0,this.tokennumber);aj.push(ac);af=(V|p|s)}else{if(this.isLeftParenth()){if((af&m)===0){this.error_parsing(this.pos,'unexpected "("')}if(af&t){ag+=2;this.tokenprio=-2;this.tokenindex=-1;this.addfunc(aj,ad,H)}af=(Z|m|a|G|W)}else{if(this.isRightParenth()){if(af&W){var ac=new e(Q,0,0,[]);aj.push(ac)}else{if((af&p)===0){this.error_parsing(this.pos,'unexpected ")"')}}af=(V|p|s|m|t)}else{if(this.isComma()){if((af&s)===0){this.error_parsing(this.pos,'unexpected ","')}this.addfunc(aj,ad,I);ag+=2;af=(Z|m|a|G)}else{if(this.isConst()){if((af&Z)===0){this.error_parsing(this.pos,"unexpected constant")}var ab=new e(Q,0,0,this.tokennumber);aj.push(ab);af=(V|p|s)}else{if(this.isOp2()){if((af&a)===0){this.error_parsing(this.pos,"unexpected function")}this.addfunc(aj,ad,I);ag+=2;af=(m)}else{if(this.isOp1()){if((af&a)===0){this.error_parsing(this.pos,"unexpected function")}this.addfunc(aj,ad,M);ag++;af=(m)}else{if(this.isVar()){if((af&Z)===0){this.error_parsing(this.pos,"unexpected variable")}var ah=new e(x,this.tokenindex,0,0);aj.push(ah);af=(V|p|s|m|t)}else{if(this.isWhite()){}else{if(this.errormsg===""){this.error_parsing(this.pos,"unknown character")}else{this.error_parsing(this.pos,this.errormsg)}}}}}}}}}}}}}if(this.tmpprio<0||this.tmpprio>=10){this.error_parsing(this.pos,'unmatched "()"')}while(ad.length>0){var ae=ad.pop();aj.push(ae)}if(ag+1!==aj.length){this.error_parsing(this.pos,"parity")}return new S(aj,P(this.ops1),P(this.ops2),P(this.functions))},evaluate:function(ab,ac){return this.parse(ab).evaluate(ac)},error_parsing:function(ab,ac){this.success=false;this.errormsg="parse error [column "+(ab)+"]: "+ac;this.column=ab;throw new Error(this.errormsg)},addfunc:function(ae,ab,ad){var ac=new e(ad,this.tokenindex,this.tokenprio+this.tmpprio,0);while(ab.length>0){if(ac.prio_<=ab[ab.length-1].prio_){ae.push(ab.pop())}else{break}}ab.push(ac)},isNumber:function(){var ac=false;var ad="";while(this.pos<this.expression.length){var ab=this.expression.charCodeAt(this.pos);if((ab>=48&&ab<=57)||ab===46){ad+=this.expression.charAt(this.pos);this.pos++;this.tokennumber=parseFloat(ad);ac=true}else{break}}return ac},unescape:function(ac,ah){var ab=[];var ag=false;for(var ae=0;ae<ac.length;ae++){var af=ac.charAt(ae);if(ag){switch(af){case"'":ab.push("'");break;case"\\":ab.push("\\");break;case"/":ab.push("/");break;case"b":ab.push("\b");break;case"f":ab.push("\f");break;case"n":ab.push("\n");break;case"r":ab.push("\r");break;case"t":ab.push("\t");break;case"u":var ad=parseInt(ac.substring(ae+1,ae+5),16);ab.push(String.fromCharCode(ad));ae+=4;break;default:throw this.error_parsing(ah+ae,"Illegal escape sequence: '\\"+af+"'")}ag=false}else{if(af=="\\"){ag=true}else{ab.push(af)}}}return ab.join("")},isString:function(){var ac=false;var ae="";var ad=this.pos;if(this.pos<this.expression.length&&this.expression.charAt(this.pos)=="'"){this.pos++;while(this.pos<this.expression.length){var ab=this.expression.charAt(this.pos);if(ab!="'"||ae.slice(-1)=="\\"){ae+=this.expression.charAt(this.pos);this.pos++}else{this.pos++;this.tokennumber=this.unescape(ae,ad);ac=true;break}}}return ac},isConst:function(){var ad;for(var ac in this.consts){if(true){var ab=ac.length;ad=this.expression.substr(this.pos,ab);if(ac===ad){this.tokennumber=this.consts[ac];this.pos+=ab;return true}}}return false},isOperator:function(){var ab=this.expression.charCodeAt(this.pos);if(ab===43){this.tokenprio=2;this.tokenindex="+"}else{if(ab===45){this.tokenprio=2;this.tokenindex="-"}else{if(ab===62){if(this.expression.charCodeAt(this.pos+1)===61){this.pos++;this.tokenprio=1;this.tokenindex=">="}else{this.tokenprio=1;this.tokenindex=">"}}else{if(ab===60){if(this.expression.charCodeAt(this.pos+1)===61){this.pos++;this.tokenprio=1;this.tokenindex="<="}else{this.tokenprio=1;this.tokenindex="<"}}else{if(ab===124){if(this.expression.charCodeAt(this.pos+1)===124){this.pos++;this.tokenprio=1;this.tokenindex="||"}else{return false}}else{if(ab===61){if(this.expression.charCodeAt(this.pos+1)===61){this.pos++;this.tokenprio=1;this.tokenindex="=="}else{return false}}else{if(ab===33){if(this.expression.charCodeAt(this.pos+1)===61){this.pos++;this.tokenprio=1;this.tokenindex="!="}else{return false}}else{if(ab===97){if(this.expression.charCodeAt(this.pos+1)===110&&this.expression.charCodeAt(this.pos+2)===100){this.pos++;this.pos++;this.tokenprio=0;this.tokenindex="and"}else{return false}}else{if(ab===111){if(this.expression.charCodeAt(this.pos+1)===114){this.pos++;this.tokenprio=0;this.tokenindex="or"}else{return false}}else{if(ab===42||ab===8729||ab===8226){this.tokenprio=3;this.tokenindex="*"}else{if(ab===47){this.tokenprio=4;this.tokenindex="/"}else{if(ab===37){this.tokenprio=4;this.tokenindex="%"}else{if(ab===94){this.tokenprio=5;this.tokenindex="^"}else{return false}}}}}}}}}}}}}this.pos++;return true},isSign:function(){var ab=this.expression.charCodeAt(this.pos-1);if(ab===45||ab===43){return true}return false},isPositiveSign:function(){var ab=this.expression.charCodeAt(this.pos-1);if(ab===43){return true}return false},isNegativeSign:function(){var ab=this.expression.charCodeAt(this.pos-1);if(ab===45){return true}return false},isLeftParenth:function(){var ab=this.expression.charCodeAt(this.pos);if(ab===40){this.pos++;this.tmpprio+=10;return true}return false},isRightParenth:function(){var ab=this.expression.charCodeAt(this.pos);if(ab===41){this.pos++;this.tmpprio-=10;return true}return false},isComma:function(){var ab=this.expression.charCodeAt(this.pos);if(ab===44){this.pos++;this.tokenprio=-1;this.tokenindex=",";return true}return false},isWhite:function(){var ab=this.expression.charCodeAt(this.pos);if(ab===32||ab===9||ab===10||ab===13){this.pos++;return true}return false},isOp1:function(){var ac="";for(var ab=this.pos;ab<this.expression.length;ab++){var ad=this.expression.charAt(ab);if(ad.toUpperCase()===ad.toLowerCase()){if(ab===this.pos||(ad!="_"&&(ad<"0"||ad>"9"))){break}}ac+=ad}if(ac.length>0&&(ac in this.ops1)){this.tokenindex=ac;this.tokenprio=5;this.pos+=ac.length;return true}return false},isOp2:function(){var ac="";for(var ab=this.pos;ab<this.expression.length;ab++){var ad=this.expression.charAt(ab);if(ad.toUpperCase()===ad.toLowerCase()){if(ab===this.pos||(ad!="_"&&(ad<"0"||ad>"9"))){break}}ac+=ad}if(ac.length>0&&(ac in this.ops2)){this.tokenindex=ac;this.tokenprio=5;this.pos+=ac.length;return true}return false},isVar:function(){var ac="";for(var ab=this.pos;ab<this.expression.length;ab++){var ad=this.expression.charAt(ab);if(ad.toUpperCase()===ad.toLowerCase()){if(ab===this.pos||(ad!="_"&&ad!="."&&(ad<"0"||ad>"9"))){break}}ac+=ad}if(ac.length>0){this.tokenindex=ac;this.tokenprio=4;this.pos+=ac.length;return true}return false},isComment:function(){var ab=this.expression.charCodeAt(this.pos-1);if(ab===47&&this.expression.charCodeAt(this.pos)===42){this.pos=this.expression.indexOf("*/",this.pos)+2;if(this.pos===1){this.pos=this.expression.length}return true}return false}};K.Parser=d;return d})(typeof exports==="undefined"?{}:exports);
